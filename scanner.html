<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      padding: 10px; 
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #a8ffb0, #d9a8ff);
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: linear-gradient(135deg, #222, #555);
      color: #eee;
    }
    h2 {
      color: #333;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.6);
    }
    body.dark h2 {
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
    }
    #result { 
      font-size: 1.1em; 
      margin-top: 10px; 
      background: rgba(255,255,255,0.8);
      display: inline-block;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 95%;
      word-wrap: break-word;
    }
    body.dark #result {
      background: rgba(0,0,0,0.6);
      color: #fff;
    }
    select, #sendBtn, #themeToggle {
      margin-top: 12px;
      padding: 8px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #aaa;
    }
    #sendBtn {
      background-color: green;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    #sendBtn:hover { background-color: darkgreen; }

    #themeToggle {
      background-color: #444;
      color: #fff;
      cursor: pointer;
    }
    body.dark #themeToggle {
      background-color: #ddd;
      color: #000;
    }
    #reader {
      width: 100%;
      max-width: 320px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h2>Scan Kartu Absensi</h2>
  <button id="themeToggle">üåô Gelap/Terang ‚òÄÔ∏è</button>
  <div id="reader"></div>
  <div id="result">Hasil scan akan muncul di sini</div>
  
  <div>
    <select id="kondisiSelect" style="display:none;">
      <option value="Masuk">Masuk</option>
      <option value="Izin Keluar">Izin Keluar</option>
      <option value="Kembali">Kembali</option>
      <option value="Pulang">Pulang</option>
    </select>
  </div>
  
  <div>
    <input type="text" id="alasanInput" placeholder="Tulis alasan..." style="display:none; margin-top:10px; padding:8px; border-radius:6px; width:90%;">
  </div>
  
  <br>
  <button id="sendBtn" style="display:none;">Kirim ke WhatsApp & Simpan</button>

  <script>
    const resultEl = document.getElementById('result');
    const sendBtn = document.getElementById('sendBtn');
    const kondisiSelect = document.getElementById('kondisiSelect');
    const alasanInput = document.getElementById('alasanInput');
    const themeToggle = document.getElementById('themeToggle');
    
    // Ambil waktu dari perangkat (local time user)
    function getLocalTimestamp() {
    const now = new Date();
    // Format jadi YYYY-MM-DD HH:mm:ss
    return now.getFullYear() + "-" +
           String(now.getMonth()+1).padStart(2,"0") + "-" +
           String(now.getDate()).padStart(2,"0") + " " +
           String(now.getHours()).padStart(2,"0") + ":" +
           String(now.getMinutes()).padStart(2,"0") + ":" +
           String(now.getSeconds()).padStart(2,"0");
    }

    let scanParts = [];
    const webhookURL = "https://script.google.com/macros/s/AKfycbyJYotpum3BLRHk9VNOngElWqKEaBV3r_l3BecuiQE_zuqaA5HPuMvWhyse5OOK5kyJ/exec"; // Ganti dengan URL Google Apps Script Web App

    // === Load tema terakhir dari localStorage ===
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
    }

    // === Switch tema dan simpan ke localStorage ===
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    });

    function onScanSuccess(decodedText) {
      scanParts = decodedText.split(",");
      if (scanParts.length < 5) {
        resultEl.textContent = "Format QR Code tidak valid!";
        kondisiSelect.style.display = 'none';
        sendBtn.style.display = 'none';
        alasanInput.style.display = 'none';
        return;
      }
      resultEl.innerHTML = 
        `NIS   : ${scanParts[0]}<br>` +
        `Nama  : ${scanParts[1]}<br>` +
        `Kelas : ${scanParts[2]}`;
      kondisiSelect.style.display = 'inline-block';
      alasanInput.style.display = 'inline-block';
      sendBtn.style.display = 'inline-block';
    }

    // Mulai kamera (pilih belakang kalau ada)
    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        let cameraId = cameras.length > 1 ? cameras[1].id : cameras[0].id;
        html5QrCode.start(
          { deviceId: { exact: cameraId } },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess
        ).catch(err => resultEl.textContent = "Error kamera: " + err);
      } else {
        resultEl.textContent = "Tidak ada kamera terdeteksi";
      }
    }).catch(err => resultEl.textContent = "Gagal mengakses kamera: " + err);

    sendBtn.addEventListener('click', () => {
      if (scanParts.length < 5) {
        alert("Belum ada hasil scan yang valid!");
        return;
      }
      const kondisi = kondisiSelect.value;
      const alasan = alasanInput.value.trim() || "-";
      const timestamp = getLocalTimestamp();  // waktu dari perangkat user

      // Simpan ke Google Sheets
      fetch(webhookURL, {
        method: "POST",
        body: `timestamp=${encodeURIComponent(timestamp)}&kondisi=${encodeURIComponent(kondisi)}&alasan=${encodeURIComponent(alasan)}&nis=${encodeURIComponent(scanParts[0])}&nama=${encodeURIComponent(scanParts[1])}&kelas=${encodeURIComponent(scanParts[2])}&hp1=${encodeURIComponent(scanParts[3])}&hp2=${encodeURIComponent(scanParts[4])}`,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      }).then(res => {
        if (res.ok) {
          alert("‚úÖ Data berhasil dikirim dan disimpan!");
        } else {
          alert("‚ùå Gagal menyimpan data!");
        }
      }).catch(err => alert("‚ö†Ô∏è Error koneksi: " + err));

      // Pesan WA
      const hp2Clean = scanParts[4].replace(/\D/g, '');
      const pesan = 
        `Assalamu'alaikum wr.wb.%0A` +
        `Dengan ini kami sampaikan :%0A%0A`+
        `${encodeURIComponent(scanParts[1])}%0A`+
        `${encodeURIComponent(scanParts[0])}%0A`+
        `${encodeURIComponent(scanParts[2])}%0A` +
        `${encodeURIComponent(kondisi)}%0A` +
        `Alasan: ${encodeURIComponent(alasan)}%0A` +
        `${timestamp}%0A%0A`+
        `Terima kasih`;

      window.open(`https://wa.me/${hp2Clean}?text=${pesan}`, '_blank');
    });
  </script>
</body>
</html>
